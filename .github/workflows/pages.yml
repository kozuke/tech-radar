# Tech Radar - GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# data/ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ã‚µã‚¤ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

name: Deploy to GitHub Pages

on:
  # data/ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ãƒˆãƒªã‚¬ãƒ¼
  push:
    branches:
      - main
    paths:
      - 'site/**'
      - 'data/**'

  # collect.ymlãŒå®Œäº†ã—ãŸæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼
  workflow_run:
    workflows: ["Collect Articles"]
    types:
      - completed
    branches:
      - main

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:

# GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™
permissions:
  contents: read
  pages: write
  id-token: write

# åŒæ™‚å®Ÿè¡Œã®åˆ¶å¾¡ï¼ˆå…·ä½“çš„ãªã‚°ãƒ«ãƒ¼ãƒ—åã§ç«¶åˆã‚’å›é¿ï¼‰
concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # workflow_runã§ãƒˆãƒªã‚¬ãƒ¼ã•ã‚ŒãŸå ´åˆã¯ã€å…ƒã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      slack_summary: ${{ steps.extract_summary.outputs.summary }}
      latest_digest_date: ${{ steps.extract_summary.outputs.date }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: site
        run: npm install

      - name: Copy data to public
        run: |
          mkdir -p site/public/data
          cp -r data/* site/public/data/

      - name: Copy articles to site
        run: |
          # è¨˜äº‹MDã‚’VitePressã§è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã‚³ãƒ”ãƒ¼
          cp data/items/*.md site/articles/ 2>/dev/null || true

      - name: Extract Slack summary from latest digest
        id: extract_summary
        run: |
          # æœ€æ–°ã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          LATEST_DIGEST=$(ls -t data/items/*__daily-digest.md 2>/dev/null | head -1)
          
          if [ -n "$LATEST_DIGEST" ] && [ -f "$LATEST_DIGEST" ]; then
            # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ—¥ä»˜ã‚’æŠ½å‡º
            DATE=$(basename "$LATEST_DIGEST" | sed 's/__daily-digest.md//')
            echo "date=$DATE" >> $GITHUB_OUTPUT
            
            # SLACK_SUMMARY_START ã¨ SLACK_SUMMARY_END ã®é–“ã‚’æŠ½å‡º
            SUMMARY=$(sed -n '/<!-- SLACK_SUMMARY_START -->/,/<!-- SLACK_SUMMARY_END -->/p' "$LATEST_DIGEST" | \
                      sed '1d;$d' | \
                      tr '\n' '\\n' | \
                      sed 's/\\n$//')
            
            if [ -n "$SUMMARY" ]; then
              # GitHub Actions outputã«è¨­å®šï¼ˆæ”¹è¡Œã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
              echo "summary<<EOF" >> $GITHUB_OUTPUT
              sed -n '/<!-- SLACK_SUMMARY_START -->/,/<!-- SLACK_SUMMARY_END -->/p' "$LATEST_DIGEST" | sed '1d;$d' >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "summary=æ–°ã—ã„è¨˜äº‹ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ã‚µã‚¤ãƒˆã§ã”ç¢ºèªãã ã•ã„ã€‚" >> $GITHUB_OUTPUT
            fi
          else
            echo "date=" >> $GITHUB_OUTPUT
            echo "summary=ã‚µã‚¤ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_OUTPUT
          fi

      - name: Build site
        working-directory: site
        run: npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/.vitepress/dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          timeout: 600000
          error_count: 10
          reporting_interval: 5000

      - name: Notify Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_SUMMARY: ${{ needs.build.outputs.slack_summary }}
          DIGEST_DATE: ${{ needs.build.outputs.latest_digest_date }}
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
        run: |
          # Webhook URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL is not set, skipping notification"
            exit 0
          fi
          
          # Slack Block Kitå½¢å¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
          # ã‚µãƒãƒªãƒ¼ã®æ”¹è¡Œã‚’é©åˆ‡ã«å‡¦ç†
          SUMMARY_TEXT=$(echo "$SLACK_SUMMARY" | sed 's/"/\\"/g')
          
          # æ—¥ä»˜ãŒã‚ã‚‹å ´åˆã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã«å«ã‚ã‚‹
          if [ -n "$DIGEST_DATE" ]; then
            HEADER="ğŸ“° *Tech Radar Daily Digest - $DIGEST_DATE*"
          else
            HEADER="ğŸ“° *Tech Radar* ã‚µã‚¤ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ"
          fi
          
          # Slack Webhook ã«é€ä¿¡
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"Tech Radar æ›´æ–°é€šçŸ¥\",
                    \"emoji\": true
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"$HEADER\"
                  }
                },
                {
                  \"type\": \"divider\"
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"$SUMMARY_TEXT\"
                  }
                },
                {
                  \"type\": \"divider\"
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"ğŸ“– ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹\",
                        \"emoji\": true
                      },
                      \"url\": \"$PAGE_URL\",
                      \"style\": \"primary\"
                    }
                  ]
                }
              ]
            }" \
            "$SLACK_WEBHOOK_URL"
